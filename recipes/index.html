
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A memory leak detection library for Android">
      
      
        <meta name="author" content="Square, Inc.">
      
      
        <link rel="canonical" href="https://square.github.io/leakcanary/recipes/">
      
      
        <link rel="prev" href="../leakcanary-for-releases/">
      
      
        <link rel="next" href="../faq/">
      
      <link rel="icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.10">
    
    
      
        <title>Code recipes - LeakCanary</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#code-recipes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
             
   Upgrade to <a href="../changelog/">LeakCanary <strong>2.14</strong></a> üê§ Want to help?  <a href="../how_to_help/">Here's how you can contribute<a> üôè

          </div>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="LeakCanary" class="md-header__button md-logo" aria-label="LeakCanary" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LeakCanary
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Code recipes
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/square/leakcanary" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="LeakCanary" class="md-nav__button md-logo" aria-label="LeakCanary" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    LeakCanary
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/square/leakcanary" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Fundamentals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Fundamentals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals-how-leakcanary-works/" class="md-nav__link">
        How LeakCanary works
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals-fixing-a-memory-leak/" class="md-nav__link">
        Fixing a memory leak
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          LeakCanary at scale
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LeakCanary at scale
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ui-tests/" class="md-nav__link">
        Leak detection in UI tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../uploading/" class="md-nav__link">
        Uploading analysis results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leakcanary-for-releases/" class="md-nav__link">
        LeakCanary for releases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Help & Community
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Help & Community
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Code recipes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Code recipes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#watching-objects-with-a-lifecycle" class="md-nav__link">
    Watching objects with a lifecycle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disabling-leakcanary" class="md-nav__link">
    Disabling LeakCanary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leakcanary-test-environment-detection" class="md-nav__link">
    LeakCanary test environment detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#counting-retained-instances-in-release-builds" class="md-nav__link">
    Counting retained instances in release builds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leakcanary-in-release-builds" class="md-nav__link">
    LeakCanary in release builds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-tv" class="md-nav__link">
    Android TV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#icon-and-label" class="md-nav__link">
    Icon and label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matching-known-library-leaks" class="md-nav__link">
    Matching known library leaks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ignoring-specific-activities-or-fragment-classes" class="md-nav__link">
    Ignoring specific activities or fragment classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-leaking-objects-and-labeling-objects" class="md-nav__link">
    Identifying leaking objects and labeling objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-leakcanary-analysis-in-a-separate-process" class="md-nav__link">
    Running the LeakCanary analysis in a separate process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-leakcanary-for-different-product-flavors" class="md-nav__link">
    Setting up LeakCanary for different product flavors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-metadata-from-the-heap-dump" class="md-nav__link">
    Extracting metadata from the heap dump
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-leakcanary-with-obfuscated-apps" class="md-nav__link">
    Using LeakCanary with obfuscated apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-leaks-in-jvm-applications" class="md-nav__link">
    Detecting leaks in JVM applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packagemanagergetlaunchintentforpackage-returns-leaklauncheractivity" class="md-nav__link">
    PackageManager.getLaunchIntentForPackage() returns LeakLauncherActivity
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../support/" class="md-nav__link">
        Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrading-to-leakcanary-2.0/" class="md-nav__link">
        Upgrading to LeakCanary 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../recorded-presentations/" class="md-nav__link">
        Recorded Presentations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blog-articles/" class="md-nav__link">
        Blog Articles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://stackoverflow.com/questions/tagged/leakcanary?sort=active" class="md-nav__link">
        Stack Overflow ‚èè
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
      
      
      
        <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../code_of_conduct/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dev-env/" class="md-nav__link">
        Dev Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../releasing/" class="md-nav__link">
        Releasing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_help/" class="md-nav__link">
        How to help
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Shark
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Shark
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shark/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/shark/" class="md-nav__link">
        Shark API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api/leakcanary/" class="md-nav__link">
        LeakCanary API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#watching-objects-with-a-lifecycle" class="md-nav__link">
    Watching objects with a lifecycle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disabling-leakcanary" class="md-nav__link">
    Disabling LeakCanary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leakcanary-test-environment-detection" class="md-nav__link">
    LeakCanary test environment detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#counting-retained-instances-in-release-builds" class="md-nav__link">
    Counting retained instances in release builds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leakcanary-in-release-builds" class="md-nav__link">
    LeakCanary in release builds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-tv" class="md-nav__link">
    Android TV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#icon-and-label" class="md-nav__link">
    Icon and label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matching-known-library-leaks" class="md-nav__link">
    Matching known library leaks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ignoring-specific-activities-or-fragment-classes" class="md-nav__link">
    Ignoring specific activities or fragment classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-leaking-objects-and-labeling-objects" class="md-nav__link">
    Identifying leaking objects and labeling objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-leakcanary-analysis-in-a-separate-process" class="md-nav__link">
    Running the LeakCanary analysis in a separate process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-leakcanary-for-different-product-flavors" class="md-nav__link">
    Setting up LeakCanary for different product flavors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-metadata-from-the-heap-dump" class="md-nav__link">
    Extracting metadata from the heap dump
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-leakcanary-with-obfuscated-apps" class="md-nav__link">
    Using LeakCanary with obfuscated apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-leaks-in-jvm-applications" class="md-nav__link">
    Detecting leaks in JVM applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packagemanagergetlaunchintentforpackage-returns-leaklauncheractivity" class="md-nav__link">
    PackageManager.getLaunchIntentForPackage() returns LeakLauncherActivity
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
    
  <span style="float: right">ü§î Documentation issue? <a href="https://github.com/square/leakcanary/issues/new?assignees=&labels=type%3A+documentation&template=4-doc.md&title=Doc%20issue%20with%20recipes/%20page">Report</a> or <a href="https://github.com/square/leakcanary/edit/main/docs/recipes.md">edit</a></span>
    
  
  
    
  
  
  <h1 id="code-recipes">Code Recipes<a class="headerlink" href="#code-recipes" title="Permanent link">&para;</a></h1>
<p>This page contains code recipes to customize LeakCanary to your needs. Read through the section titles and cook your own meal! Also don&rsquo;t forget to check out the <a href="../faq/">FAQ</a>.</p>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
<p>If you think a recipe might be missing or you&rsquo;re not sure that what you&rsquo;re trying to achieve is possible with the current APIs, please <a href="https://github.com/square/leakcanary/issues/new/choose">file an issue</a>. Your feedback helps us make LeakCanary better for the entire community.</p>
</div>
<h2 id="watching-objects-with-a-lifecycle">Watching objects with a lifecycle<a class="headerlink" href="#watching-objects-with-a-lifecycle" title="Permanent link">&para;</a></h2>
<p>The default configuration of LeakCanary will automatically watch Activity, Fragment, Fragment View and ViewModel instances.</p>
<p>In your application, you may have other objects with a lifecycle, such as services, Dagger components, etc. Use <a href="/leakcanary/api/leakcanary/-app-watcher/object-watcher/">AppWatcher.objectWatcher</a> to watch instances that should be garbage collected:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyService</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// ...</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onDestroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="na">onDestroy</span><span class="p">()</span>
<span class="w">    </span><span class="n">AppWatcher</span><span class="p">.</span><span class="na">objectWatcher</span><span class="p">.</span><span class="na">watch</span><span class="p">(</span>
<span class="w">      </span><span class="n">watchedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">,</span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MyService received Service#onDestroy() callback&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<p>LeakCanary has a default configuration that works well for most apps. You can also customize it to your needs. The LeakCanary configuration is held by two singleton objects (<code>AppWatcher</code> and <code>LeakCanary</code>) and can be updated at any time. Most developers configure LeakCanary in their <strong>debug</strong> <a href="https://developer.android.com/reference/android/app/Application">Application</a> class:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">DebugExampleApplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExampleApplication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span>
<span class="w">    </span><span class="n">AppWatcher</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppWatcher</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">watchFragmentViews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Create a debug application class in your <code>src/debug/java</code> folder. Don&rsquo;t forget to also register it in <code>src/debug/AndroidManifest.xml</code>.</p>
</div>
<p>To customize the detection of retained objects at runtime, specify the watchers you wish to install via <a href="/leakcanary/api/leakcanary/-app-watcher/manual-install/">AppWatcher.manualInstall()</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">watchersToInstall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppWatcher</span><span class="p">.</span><span class="na">appDefaultWatchers</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="na">filter</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="k">!is</span><span class="w"> </span><span class="n">FragmentAndViewModelWatcher</span><span class="w"> </span><span class="p">}</span>
<span class="n">AppWatcher</span><span class="p">.</span><span class="na">manualInstall</span><span class="p">(</span>
<span class="w">  </span><span class="n">application</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">,</span>
<span class="w">  </span><span class="n">watchersToInstall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watchersToInstall</span>
<span class="p">)</span>
</code></pre></div>
<p>To customize the heap dumping &amp; analysis, update <a href="/leakcanary/api/leakcanary/-leak-canary/config/">LeakCanary.config</a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">retainedVisibleThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Java</p>
<p>In Java, use <a href="/leakcanary/api/leakcanary/-leak-canary/-config/-builder/">LeakCanary.Config.Builder</a> instead:</p>
<div class="highlight"><pre><span></span><code><span class="n">LeakCanary</span><span class="p">.</span><span class="na">Config</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">getConfig</span><span class="p">().</span><span class="na">newBuilder</span><span class="p">()</span>
<span class="w">   </span><span class="p">.</span><span class="na">retainedVisibleThreshold</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">   </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="n">LeakCanary</span><span class="p">.</span><span class="na">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</code></pre></div>
</div>
<p>Configure the LeakCanary UI by overriding the following resources:</p>
<ul>
<li><code>mipmap/leak_canary_icon</code> see <a href="#icon-and-label">Icon and label</a></li>
<li><code>string/leak_canary_display_activity_label</code> see <a href="#icon-and-label">Icon and label</a></li>
<li><code>bool/leak_canary_add_dynamic_shortcut</code> see <a href="#disabling-leakcanary">Disabling LeakCanary</a></li>
<li><code>bool/leak_canary_add_launcher_icon</code> see <a href="#disabling-leakcanary">Disabling LeakCanary</a></li>
<li><code>layout/leak_canary_heap_dump_toast</code> the layout for the toast shown when the heap is dumped</li>
</ul>
<h2 id="disabling-leakcanary">Disabling LeakCanary<a class="headerlink" href="#disabling-leakcanary" title="Permanent link">&para;</a></h2>
<p>Sometimes it&rsquo;s necessary to disable LeakCanary temporarily, for example for a product demo or when running performance tests. You have different options, depending on what you&rsquo;re trying to achieve:</p>
<ul>
<li>Create a build variant that does not include the LeakCanary dependencies, see <a href="#setting-up-leakcanary-for-different-product-flavors">Setting up LeakCanary for different product flavors</a>.</li>
<li>Disable the heap dumping &amp; analysis: <code>LeakCanary.config = LeakCanary.config.copy(dumpHeap = false)</code>.</li>
<li>Hide the leak display activity launcher icon: override <code>R.bool.leak_canary_add_launcher_icon</code> or call <code>LeakCanary.showLeakDisplayActivityLauncherIcon(false)</code></li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When you set <code>LeakCanary.Config.dumpHeap</code> to <code>false</code>, <code>AppWatcher.objectWatcher</code> will still keep track of retained objects, and LeakCanary will look for these objects when you change <code>LeakCanary.Config.dumpHeap</code> back to <code>true</code>.</p>
</div>
<h2 id="leakcanary-test-environment-detection">LeakCanary test environment detection<a class="headerlink" href="#leakcanary-test-environment-detection" title="Permanent link">&para;</a></h2>
<p>By default, LeakCanary will look for the <code>org.junit.Test</code> class in your classpath and if found, will disable itself to avoid running in tests. However, some apps may ship JUnit in their debug classpaths (for example, when using OkHttp&rsquo;s MockWebServer) so we offer a way to customise the class that is used to determine that the app is running in a test environment.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;resources&gt;</span>
<span class="w">  </span><span class="nt">&lt;string</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;leak_canary_test_class_name&quot;</span><span class="nt">&gt;</span>assertk.Assert<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div>
<h2 id="counting-retained-instances-in-release-builds">Counting retained instances in release builds<a class="headerlink" href="#counting-retained-instances-in-release-builds" title="Permanent link">&para;</a></h2>
<p>The <code>com.squareup.leakcanary:leakcanary-android</code> dependency should only be used in debug builds. It depends on <code>com.squareup.leakcanary:leakcanary-object-watcher-android</code> which you can use in release builds to track and count retained instances.</p>
<p>In your <code>build.gradle</code>:</p>
<div class="highlight"><pre><span></span><code>dependencies {
  implementation &#39;com.squareup.leakcanary:leakcanary-object-watcher-android:2.14&#39;
}
</code></pre></div>
<p>In your leak reporting code:
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">retainedInstanceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppWatcher</span><span class="p">.</span><span class="na">objectWatcher</span><span class="p">.</span><span class="na">retainedObjectCount</span>
</code></pre></div></p>
<h2 id="leakcanary-in-release-builds">LeakCanary in release builds<a class="headerlink" href="#leakcanary-in-release-builds" title="Permanent link">&para;</a></h2>
<p>We <strong>do not recommend</strong> including LeakCanary in release builds, as it could negatively impact the experience of your customers. To avoid accidentally including the <code>com.squareup.leakcanary:leakcanary-android</code> dependency in a release build, LeakCanary crashes during initialization if the APK is not debuggable. You may have a good reason to create a non debuggable build that includes LeakCanary, for example for a QA build. If necessary, the crashing check can be disabled by overriding the <code>bool/leak_canary_allow_in_non_debuggable_build</code> resource, e.g. by creating a file under <code>res/values</code> with the following contents:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
<span class="w">  </span><span class="nt">&lt;bool</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;leak_canary_allow_in_non_debuggable_build&quot;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/bool&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div>
<h2 id="android-tv">Android TV<a class="headerlink" href="#android-tv" title="Permanent link">&para;</a></h2>
<p>LeakCanary works on Android TV devices (FireTV, Nexus player, Nvidia Shield, MiBox, etc.) without any additional setup. However, there are couple things you need to be aware of:</p>
<ul>
<li>Android TV doesn&rsquo;t have notifications. LeakCanary will display Toast messages when objects become retained and when leak analysis completes. You can also check Logcat for more details.</li>
<li>Due to lack of notifications, the only way to <strong>manually</strong> trigger a heap dump is to background the app.</li>
<li>There&rsquo;s a <a href="https://issuetracker.google.com/issues/141429184">bug on API 26+ devices</a> that prevents the activity that displays leaks from appearing in apps list. As a workaround, LeakCanary prints an <code>adb shell</code> command in Logcat after heap dump analysis that launches leak list activity:
    <div class="highlight"><pre><span></span><code>adb shell am start -n &quot;com.your.package.name/leakcanary.internal.activity.LeakLauncherActivity&quot;
</code></pre></div></li>
<li>Some Android TV devices have very little memory available per app process and this might impact LeakCanary. <a href="#running-the-leakcanary-analysis-in-a-separate-process">Running the LeakCanary analysis in a separate process</a> might help in such cases.</li>
</ul>
<h2 id="icon-and-label">Icon and label<a class="headerlink" href="#icon-and-label" title="Permanent link">&para;</a></h2>
<p>The activity that displays leaks comes with a default icon and label, which you can change by providing <code>R.mipmap.leak_canary_icon</code> and <code>R.string.leak_canary_display_activity_label</code> in your app:</p>
<div class="highlight"><pre><span></span><code>res/
  mipmap-hdpi/
    leak_canary_icon.png
  mipmap-mdpi/
    leak_canary_icon.png
  mipmap-xhdpi/
    leak_canary_icon.png
  mipmap-xxhdpi/
    leak_canary_icon.png
  mipmap-xxxhdpi/
    leak_canary_icon.png
   mipmap-anydpi-v26/
     leak_canary_icon.xml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
<span class="w">  </span><span class="nt">&lt;string</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;leak_canary_display_activity_label&quot;</span><span class="nt">&gt;</span>MyLeaks<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div>
<h2 id="matching-known-library-leaks">Matching known library leaks<a class="headerlink" href="#matching-known-library-leaks" title="Permanent link">&para;</a></h2>
<p>Set <a href="/leakcanary/api/leakcanary/-leak-canary/-config/reference-matchers/">LeakCanary.Config.referenceMatchers</a> to a list that builds on top of <a href="/leakcanary/api/shark/-android-reference-matchers/-companion/app-defaults/">AndroidReferenceMatchers.appDefaults</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">DebugExampleApplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExampleApplication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span>
<span class="w">    </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">        </span><span class="n">referenceMatchers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AndroidReferenceMatchers</span><span class="p">.</span><span class="na">appDefaults</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">AndroidReferenceMatchers</span><span class="p">.</span><span class="na">staticFieldLeak</span><span class="p">(</span>
<span class="w">                </span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;com.samsing.SomeSingleton&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">fieldName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;sContext&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SomeSingleton has a static field leaking a context.&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">patternApplies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="n">manufacturer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Samsing&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sdkInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">26</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="ignoring-specific-activities-or-fragment-classes">Ignoring specific activities or fragment classes<a class="headerlink" href="#ignoring-specific-activities-or-fragment-classes" title="Permanent link">&para;</a></h2>
<p>Sometimes a 3<sup>rd</sup> party library provides its own activities or fragments which contain a number of bugs leading to leaks of those specific 3<sup>rd</sup> party activities and fragments. You should push hard on that library to fix their memory leaks as it&rsquo;s directly impacting your application. That being said, until those are fixed, you have two options:</p>
<ol>
<li>Add the specific leaks as known library leaks (see <a href="#matching-known-library-leaks">Matching known library leaks</a>). LeakCanary will run when those leaks are detected and then report them as known library leaks.</li>
<li>Disable LeakCanary automatic activity or fragment watching (e.g. <code>AppWatcher.config = AppWatcher.config.copy(watchActivities = false)</code>) and then manually pass objects to <code>AppWatcher.objectWatcher.watch</code>.</li>
</ol>
<h2 id="identifying-leaking-objects-and-labeling-objects">Identifying leaking objects and labeling objects<a class="headerlink" href="#identifying-leaking-objects-and-labeling-objects" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">DebugExampleApplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExampleApplication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">addEntityIdLabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectInspector</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">reporter</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">reporter</span><span class="p">.</span><span class="na">whenInstanceOf</span><span class="p">(</span><span class="s">&quot;com.example.DbEntity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">databaseIdField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="o">[</span><span class="s">&quot;com.example.DbEntity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;databaseId&quot;</span><span class="o">]!!</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">databaseId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">databaseIdField</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">asInt</span><span class="o">!!</span>
<span class="w">        </span><span class="n">labels</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;DbEntity.databaseId = </span><span class="si">$</span><span class="n">databaseId</span><span class="s">&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">singletonsInspector</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">AppSingletonInspector</span><span class="p">(</span><span class="s">&quot;com.example.MySingleton&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;com.example.OtherSingleton&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">mmvmInspector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectInspector</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">reporter</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">reporter</span><span class="p">.</span><span class="na">whenInstanceOf</span><span class="p">(</span><span class="s">&quot;com.mmvm.SomeViewModel&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">destroyedField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="o">[</span><span class="s">&quot;com.mmvm.SomeViewModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;destroyed&quot;</span><span class="o">]!!</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">destroyedField</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">asBoolean</span><span class="o">!!</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">leakingReasons</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;SomeViewModel.destroyed is true&quot;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">notLeakingReasons</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;SomeViewModel.destroyed is false&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">        </span><span class="n">objectInspectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AndroidObjectInspectors</span><span class="p">.</span><span class="na">appDefaults</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">listOf</span><span class="p">(</span><span class="n">addObjectIdLabel</span><span class="p">,</span><span class="w"> </span><span class="n">singletonsInspector</span><span class="p">,</span><span class="w"> </span><span class="n">mmvmInspector</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="running-the-leakcanary-analysis-in-a-separate-process">Running the LeakCanary analysis in a separate process<a class="headerlink" href="#running-the-leakcanary-analysis-in-a-separate-process" title="Permanent link">&para;</a></h2>
<p>LeakCanary runs in your main app process. LeakCanary 2 is optimized to keep memory usage low while analysing and runs in a background thread with priority <code>Process.THREAD_PRIORITY_BACKGROUND</code>. If you find that LeakCanary is still using too much memory or impacting the app process performance, you can configure it to run the analysis in a separate process.</p>
<p>All you have to do is replace the <code>leakcanary-android</code> dependency with <code>leakcanary-android-process</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1">// debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:${version}&#39;</span>
<span class="w">  </span><span class="n">debugImplementation</span><span class="w"> </span><span class="s1">&#39;com.squareup.leakcanary:leakcanary-android-process:${version}&#39;</span>
<span class="o">}</span>
</code></pre></div>
<p>You can call <a href="/leakcanary/api/leakcanary/-leak-canary-process/is-in-analyzer-process/">LeakCanaryProcess.isInAnalyzerProcess</a> to check if your Application class is being created in the LeakCanary process. This is useful when configuring libraries like Firebase that may crash when running in an unexpected process.</p>
<h2 id="setting-up-leakcanary-for-different-product-flavors">Setting up LeakCanary for different product flavors<a class="headerlink" href="#setting-up-leakcanary-for-different-product-flavors" title="Permanent link">&para;</a></h2>
<p>You can setup LeakCanary to run in a specific product flavors of your app. For example, create:</p>
<div class="highlight"><pre><span></span><code>android {
  flavorDimensions &quot;default&quot;
  productFlavors {
    prod {
      // ...
    }
    qa {
      // ...
    }
    dev {
      // ...
    }
  }
}
</code></pre></div>
<p>Then, define a custom configuration for the flavor for which you want to enable LeakCanary:</p>
<div class="highlight"><pre><span></span><code>android {
  // ...
}
configurations {
    devDebugImplementation {}
}
</code></pre></div>
<p>You can now add the LeakCanary dependency for that configuration:</p>
<div class="highlight"><pre><span></span><code>dependencies {
  devDebugImplementation &quot;com.squareup.leakcanary:leakcanary-android:${version}&quot;
}
</code></pre></div>
<h2 id="extracting-metadata-from-the-heap-dump">Extracting metadata from the heap dump<a class="headerlink" href="#extracting-metadata-from-the-heap-dump" title="Permanent link">&para;</a></h2>
<p><a href="/leakcanary/api/leakcanary/-leak-canary/-config/metadata-extractor/">LeakCanary.Config.metadataExtractor</a> extracts metadata from a heap dump. The metadata is then available in <code>HeapAnalysisSuccess.metadata</code>. <code>LeakCanary.Config.metadataExtractor</code> defaults to <code>AndroidMetadataExtractor</code> but you can replace it to extract additional metadata from the hprof.</p>
<p>For example, if you want to include the app version name in your heap analysis reports, you need to first store it in memory (e.g. in a static field) and then you can retrieve it in <code>MetadataExtractor</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">DebugExampleApplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExampleApplication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nd">@JvmStatic</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">savedVersionName</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageManager</span><span class="p">.</span><span class="na">getPackageInfo</span><span class="p">(</span><span class="n">packageName</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">savedVersionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">versionName</span>

<span class="w">    </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LeakCanary</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">        </span><span class="n">metadataExtractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MetadataExtractor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="nv">companionClass</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">graph</span><span class="p">.</span><span class="na">findClassByName</span><span class="p">(</span><span class="s">&quot;com.example.DebugExampleApplication&quot;</span><span class="p">)</span><span class="o">!!</span>

<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="nv">versionNameField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companionClass</span><span class="o">[</span><span class="s">&quot;savedVersionName&quot;</span><span class="o">]!!</span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="nv">versionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">versionNameField</span><span class="p">.</span><span class="na">valueAsInstance</span><span class="o">!!</span><span class="p">.</span><span class="na">readAsJavaString</span><span class="p">()</span><span class="o">!!</span>

<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="nv">defaultMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AndroidMetadataExtractor</span><span class="p">.</span><span class="na">extractMetadata</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="w">          </span><span class="n">mapOf</span><span class="p">(</span><span class="s">&quot;App Version Name&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">versionName</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">defaultMetadata</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="using-leakcanary-with-obfuscated-apps">Using LeakCanary with obfuscated apps<a class="headerlink" href="#using-leakcanary-with-obfuscated-apps" title="Permanent link">&para;</a></h2>
<p>If obfuscation is turned on then leak traces will be obfuscated. It&rsquo;s possible to automatically deobfuscate leak traces by using a deobfuscation gradle plugin provided by LeakCanary.</p>
<p>You have to add a plugin dependency in your root <code>build.gradle</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="n">buildscript</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">classpath</span><span class="w"> </span><span class="s1">&#39;com.squareup.leakcanary:leakcanary-deobfuscation-gradle-plugin:${version}&#39;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>And then you need to apply and configure the plugin in your app (or library) specific <code>build.gradle</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="n">apply</span><span class="w"> </span><span class="nl">plugin:</span><span class="w"> </span><span class="s1">&#39;com.android.application&#39;</span>
<span class="n">apply</span><span class="w"> </span><span class="nl">plugin:</span><span class="w"> </span><span class="s1">&#39;com.squareup.leakcanary.deobfuscation&#39;</span>

<span class="n">leakCanary</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1">// LeakCanary needs to know which variants have obfuscation turned on</span>
<span class="w">  </span><span class="n">filterObfuscatedVariants</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">variant</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">variant</span><span class="o">.</span><span class="na">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;debug&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Now you can run LeakCanary on an obfuscated app and leak traces will be automatically deobfuscated.</p>
<p><strong>Important:</strong> never use this plugin on a release variant. This plugin copies obfuscation mapping file and puts it inside the .apk, so if you use it on release build then the obfuscation becomes pointless because the code can be easily deobfuscated using mapping file.</p>
<p><strong>Warning:</strong> R8 (Google Proguard replacement) can now understand Kotlin language constructs but the side effect is that mapping files can get very large (a couple dozen megabytes). It means that the size of .apk containing copied mapping file will increase as well. This is another reason for not using this plugin on a release variant.</p>
<h2 id="detecting-leaks-in-jvm-applications">Detecting leaks in JVM applications<a class="headerlink" href="#detecting-leaks-in-jvm-applications" title="Permanent link">&para;</a></h2>
<p>While LeakCanary was designed to work out of the box on Android, it can run on any JVM with a bit of configuration.</p>
<p>Add the ObjectWatcher and Shark dependencies to your build file:</p>
<div class="highlight"><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="n">implementation</span><span class="w"> </span><span class="s1">&#39;com.squareup.leakcanary:leakcanary-object-watcher:2.14&#39;</span>
<span class="w">  </span><span class="n">implementation</span><span class="w"> </span><span class="s1">&#39;com.squareup.leakcanary:shark:2.14&#39;</span>
<span class="o">}</span>
</code></pre></div>
<p>Define a <code>HotSpotHeapDumper</code> to dump the heap:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">com.sun.management.HotSpotDiagnosticMXBean</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.management.ManagementFactory</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">HotSpotHeapDumper</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">mBean</span><span class="p">:</span><span class="w"> </span><span class="n">HotSpotDiagnosticMXBean</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">lazy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ManagementFactory</span><span class="p">.</span><span class="na">getPlatformMBeanServer</span><span class="p">()</span>
<span class="w">    </span><span class="n">ManagementFactory</span><span class="p">.</span><span class="na">newPlatformMXBeanProxy</span><span class="p">(</span>
<span class="w">        </span><span class="n">server</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;com.sun.management:type=HotSpotDiagnostic&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">HotSpotDiagnosticMXBean</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">fun</span><span class="w"> </span><span class="nf">dumpHeap</span><span class="p">(</span><span class="n">fileName</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mBean</span><span class="p">.</span><span class="na">dumpHeap</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">LIVE</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">LIVE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>
<p>Define a <code>JvmHeapAnalyzer</code> to analyze the heap when objects are retained and print the result to the console:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">leakcanary.GcTrigger</span>
<span class="k">import</span><span class="w"> </span><span class="nn">leakcanary.ObjectWatcher</span>
<span class="k">import</span><span class="w"> </span><span class="nn">leakcanary.OnObjectRetainedListener</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.io.File</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.Date</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.Locale.US</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">JvmHeapAnalyzer</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">objectWatcher</span><span class="p">:</span><span class="w"> </span><span class="n">ObjectWatcher</span><span class="p">)</span><span class="w"> </span><span class="p">:</span>
<span class="w">    </span><span class="n">OnObjectRetainedListener</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">fileNameFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="p">(</span><span class="n">DATE_PATTERN</span><span class="p">,</span><span class="w"> </span><span class="n">US</span><span class="p">)</span>

<span class="w">  </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onObjectRetained</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GcTrigger</span><span class="p">.</span><span class="na">Default</span><span class="p">.</span><span class="na">runGc</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objectWatcher</span><span class="p">.</span><span class="na">retainedObjectCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameFormat</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">Date</span><span class="p">())</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">hprofFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Dumping the heap to </span><span class="si">${</span><span class="n">hprofFile</span><span class="p">.</span><span class="na">absolutePath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">HotSpotHeapDumper</span><span class="p">.</span><span class="na">dumpHeap</span><span class="p">(</span><span class="n">hprofFile</span><span class="p">.</span><span class="na">absolutePath</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HeapAnalyzer</span><span class="p">(</span>
<span class="w">        </span><span class="n">OnAnalysisProgressListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Analysis in progress, working on: </span><span class="si">${</span><span class="n">step</span><span class="p">.</span><span class="na">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">heapDumpAnalysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analyzer</span><span class="p">.</span><span class="na">analyze</span><span class="p">(</span>
<span class="w">        </span><span class="n">heapDumpFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hprofFile</span><span class="p">,</span>
<span class="w">        </span><span class="n">leakingObjectFinder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyedWeakReferenceFinder</span><span class="p">,</span>
<span class="w">        </span><span class="n">computeRetainedHeapSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">objectInspectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectInspectors</span><span class="p">.</span><span class="na">jdkDefaults</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">heapDumpAnalysis</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">DATE_PATTERN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;yyyy-MM-dd_HH-mm-ss_SSS&#39;.hprof&#39;&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Create an <code>ObjectWatcher</code> instance and configure it to watch objects for 5 seconds before notifying a <code>JvmHeapAnalyzer</code> instance:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">scheduledExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="p">()</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">objectWatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectWatcher</span><span class="p">(</span>
<span class="w">    </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Clock</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">checkRetainedExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">scheduledExecutor</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">SECONDS</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="nv">heapAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JvmHeapAnalyzer</span><span class="p">(</span><span class="n">objectWatcher</span><span class="p">)</span>
<span class="n">objectWatcher</span><span class="p">.</span><span class="na">addOnObjectRetainedListener</span><span class="p">(</span><span class="n">heapAnalyzer</span><span class="p">)</span>
</code></pre></div>
<p>Pass objects that you expect to be garbage collected (e.g. closed resources) to the <code>ObjectWatcher</code> instance:</p>
<div class="highlight"><pre><span></span><code><span class="n">objectWatcher</span><span class="p">.</span><span class="na">watch</span><span class="p">(</span>
<span class="w">    </span><span class="n">watchedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closedResource</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="si">$</span><span class="n">closedResource</span><span class="s"> is closed and should be garbage collected&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p>If you end up using LeakCanary on a JVM, the community will definitely benefit from your experience, so don&rsquo;t hesitate to <a href="https://github.com/square/leakcanary/issues/">let us know</a>!</p>
<h2 id="packagemanagergetlaunchintentforpackage-returns-leaklauncheractivity">PackageManager.getLaunchIntentForPackage() returns LeakLauncherActivity<a class="headerlink" href="#packagemanagergetlaunchintentforpackage-returns-leaklauncheractivity" title="Permanent link">&para;</a></h2>
<p>LeakCanary adds a main activity that has a <a href="https://developer.android.com/reference/android/content/Intent#CATEGORY_LAUNCHER">Intent#CATEGORY_LAUNCHER</a> category. <a href="https://developer.android.com/reference/android/content/pm/PackageManager#getLaunchIntentForPackage(java.lang.String)">PackageManager.getLaunchIntentForPackage()</a> looks for a main activity in the category <code>Intent#CATEGORY_INFO</code>, and next for a main activity in the category <code>Intent#CATEGORY_LAUNCHER</code>. <code>PackageManager.getLaunchIntentForPackage()</code> returns the first activity that matches in the merged manifest of your app. If your app relies on <code>PackageManager.getLaunchIntentForPackage()</code>, you have two options:</p>
<ul>
<li>Add <code>Intent#CATEGORY_INFO</code> to your main activity intent filter, so that it gets picked up first. This is what the Android documentation recommends.</li>
<li>Disable the leakcanary launcher activity by setting the <code>leak_canary_add_launcher_icon</code> resource boolean to false.</li>
</ul>
  

              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2015 Square, Inc.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://square.github.io/" target="_blank" rel="noopener" title="square.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Piwai" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://stackoverflow.com/questions/tagged/leakcanary?sort=active" target="_blank" rel="noopener" title="stackoverflow.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/joinsquare/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fac441b0.min.js"></script>
      
    
  </body>
</html>